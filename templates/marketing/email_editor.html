{% extends 'base.html' %}

{% block title %}Email Editor - EmailPro{% endblock %}

{% block extra_css %}
<!-- GrapesJS CSS -->
<link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
<!-- GrapesJS Email Plugin CSS -->
<link rel="stylesheet" href="https://unpkg.com/grapesjs-preset-newsletter/dist/grapesjs-preset-newsletter.css">

<style>
    .gjs-one-bg {
        background-color: #f8fafc;
    }
    
    .gjs-two-color {
        color: #4f46e5;
    }
    
    .gjs-four-color {
        color: #4f46e5;
    }
    
    .gjs-four-color-h:hover {
        color: #6366f1;
    }
    
    /* Custom styles for the editor */
    #gjs {
        height: calc(100vh - 200px);
        overflow: hidden;
    }
    
    /* Panel styling */
    .panel {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .panel-header {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .panel-body {
        padding: 1rem;
    }
    
    /* Template thumbnails */
    .template-thumb {
        cursor: pointer;
        transition: transform 0.2s;
        border: 2px solid transparent;
    }
    
    .template-thumb:hover {
        transform: translateY(-5px);
        border-color: #4f46e5;
    }
    
    /* Custom buttons */
    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.2s;
    }
    
    .primary-btn {
        background-color: #4f46e5;
        color: white;
    }
    
    .primary-btn:hover {
        background-color: #4338ca;
    }
    
    .secondary-btn {
        background-color: white;
        border: 1px solid #e5e7eb;
        color: #374151;
    }
    
    .secondary-btn:hover {
        background-color: #f9fafb;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-900">Email Template Editor</h1>
                
                <div class="flex space-x-4">
                    <button id="show-template-library" class="action-btn secondary-btn">
                        <i class="fas fa-book mr-2"></i> Template Library
                    </button>
                    
                    <button id="preview-email" class="action-btn secondary-btn">
                        <i class="fas fa-eye mr-2"></i> Preview
                    </button>
                    
                    <button id="save-template" class="action-btn primary-btn">
                        <i class="fas fa-save mr-2"></i> Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Editor Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 gap-6">
            <div class="panel">
                <!-- Editor will be loaded here -->
                <div id="gjs"></div>
            </div>
        </div>
    </div>
    
    <!-- Save Template Modal -->
    <div id="save-template-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Save Template</h3>
                </div>
                
                <div class="p-6">
                    <form id="save-template-form">
                        <div class="mb-4">
                            <label for="template-name" class="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                            <input type="text" id="template-name" name="name" class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="template-subject" class="block text-sm font-medium text-gray-700 mb-1">Email Subject</label>
                            <input type="text" id="template-subject" name="subject" class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="template-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                            <textarea id="template-description" name="description" rows="3" class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="close-save-modal" class="action-btn secondary-btn">Cancel</button>
                            <button type="submit" class="action-btn primary-btn">Save Template</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Template Library Modal -->
    <div id="template-library-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-50"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Template Library</h3>
                    <button id="close-library-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <!-- Template thumbnails will be loaded here dynamically -->
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Welcome+Email" alt="Welcome Email Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Welcome Email</p>
                        </div>
                        
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Newsletter" alt="Newsletter Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Newsletter</p>
                        </div>
                        
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Promotional" alt="Promotional Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Promotional</p>
                        </div>
                        
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Product+Launch" alt="Product Launch Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Product Launch</p>
                        </div>
                        
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Event+Invitation" alt="Event Invitation Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Event Invitation</p>
                        </div>
                        
                        <div class="template-thumb">
                            <img src="https://via.placeholder.com/300x300.png?text=Feedback+Request" alt="Feedback Request Template" class="rounded-lg shadow-md">
                            <p class="mt-2 text-sm font-medium text-gray-900">Feedback Request</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- GrapesJS and Plugins -->
<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-newsletter"></script>
<script src="https://unpkg.com/grapesjs-blocks-basic"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize GrapesJS
        const editor = grapesjs.init({
            container: '#gjs',
            fromElement: false,
            storageManager: false,
            plugins: ['gjs-preset-newsletter', 'gjs-blocks-basic'],
            pluginsOpts: {
                'gjs-preset-newsletter': {
                    modalTitleImport: 'Import your HTML template'
                },
                'gjs-blocks-basic': {}
            },
            blockManager: {
                appendTo: '#blocks',
                blocks: [
                    // Additional custom blocks can be added here
                ]
            },
            deviceManager: {
                devices: [
                    {
                        id: 'desktop',
                        name: 'Desktop',
                        width: ''
                    },
                    {
                        id: 'tablet',
                        name: 'Tablet',
                        width: '768px',
                        widthMedia: '992px'
                    },
                    {
                        id: 'mobile',
                        name: 'Mobile',
                        width: '320px',
                        widthMedia: '480px'
                    }
                ]
            },
            // Styles for the editor
            styleManager: {
                appendTo: '.styles-container',
                sectors: [{
                    name: 'Dimension',
                    open: false,
                    properties: [
                        'width',
                        'height',
                        'padding',
                        'margin'
                    ]
                },{
                    name: 'Typography',
                    open: false,
                    properties: [
                        'font-family',
                        'font-size',
                        'font-weight',
                        'letter-spacing',
                        'color',
                        'line-height',
                        'text-align',
                        'text-decoration',
                        'text-shadow'
                    ]
                },{
                    name: 'Decorations',
                    open: false,
                    properties: [
                        'background-color',
                        'border',
                        'border-radius',
                        'box-shadow'
                    ]
                }]
            },
            // Canvas settings for email editing
            canvas: {
                styles: [
                    'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'
                ],
                scripts: []
            }
        });
        
        // Load default email template
        editor.setComponents(`
            <table style="width:100%; border-spacing: 0; border-collapse: collapse;">
                <tr>
                    <td style="padding: 0;">
                        <table style="margin: 0 auto; width: 600px; border-spacing: 0; border-collapse: collapse; background-color: #ffffff;">
                            <tr>
                                <td style="padding: 20px; text-align: center; background-color: #4f46e5;">
                                    <h1 style="color: white; margin: 0; font-family: 'Inter', sans-serif;">Your Email Title</h1>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 20px;">
                                    <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                        Hello,
                                    </p>
                                    <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                        This is a sample email template. Drag and drop elements to customize it to your needs.
                                    </p>
                                    <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                        Best regards,<br>
                                        Your Company
                                    </p>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 20px; text-align: center; background-color: #f3f4f6;">
                                    <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #6b7280; margin: 0;">
                                        © 2023 Your Company. All rights reserved.
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        `);
        
        // Modal toggling
        const saveTemplateModal = document.getElementById('save-template-modal');
        const templateLibraryModal = document.getElementById('template-library-modal');
        
        document.getElementById('save-template').addEventListener('click', function() {
            saveTemplateModal.classList.remove('hidden');
        });
        
        document.getElementById('close-save-modal').addEventListener('click', function() {
            saveTemplateModal.classList.add('hidden');
        });
        
        document.getElementById('show-template-library').addEventListener('click', function() {
            templateLibraryModal.classList.remove('hidden');
        });
        
        document.getElementById('close-library-modal').addEventListener('click', function() {
            templateLibraryModal.classList.add('hidden');
        });
        
        // Preview functionality
        document.getElementById('preview-email').addEventListener('click', function() {
            const html = editor.getHtml();
            const css = editor.getCss();
            
            // Create a new window to preview the email
            const win = window.open('', 'EmailPreview');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Email Preview</title>
                    <style>
                        ${css}
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 20px;
                            background-color: #f3f4f6;
                        }
                        .email-container {
                            max-width: 600px;
                            margin: 0 auto;
                            background-color: #ffffff;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        }
                    </style>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                </head>
                <body>
                    <div class="email-container">
                        ${html}
                    </div>
                </body>
                </html>
            `);
        });
        
        // Save template form submission
        document.getElementById('save-template-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const templateName = document.getElementById('template-name').value;
            const templateSubject = document.getElementById('template-subject').value;
            const templateDescription = document.getElementById('template-description').value;
            const html = editor.getHtml();
            const css = editor.getCss();
            
            // Here you would typically send this data to your backend
            const data = {
                name: templateName,
                subject: templateSubject,
                description: templateDescription,
                html_content: html,
                content: editor.getComponents().serialize(),
                styles: editor.getStyle().serialize()
            };
            
            // For demo purposes, we'll log to console and show a success message
            console.log('Template data:', data);
            
            // AJAX request to save the template would go here
            fetch('{% url "save_email_template" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Template saved successfully!');
                    saveTemplateModal.classList.add('hidden');
                } else {
                    alert('Error saving template: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the template.');
            });
        });
        
        // Template library selection
        document.querySelectorAll('.template-thumb').forEach(function(thumb) {
            thumb.addEventListener('click', function() {
                // In a real application, you would load the selected template
                // For demo purposes, we'll just close the modal
                templateLibraryModal.classList.add('hidden');
                
                // You would typically load the template based on an ID or name
                const templateName = this.querySelector('p').textContent;
                alert(`Selected template: ${templateName}`);
                
                // Example of loading a different template based on selection
                if (templateName === 'Newsletter') {
                    editor.setComponents(`
                        <table style="width:100%; border-spacing: 0; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 0;">
                                    <table style="margin: 0 auto; width: 600px; border-spacing: 0; border-collapse: collapse; background-color: #ffffff;">
                                        <tr>
                                            <td style="padding: 20px; text-align: center; background-color: #4338ca;">
                                                <h1 style="color: white; margin: 0; font-family: 'Inter', sans-serif;">Newsletter</h1>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 20px;">
                                                <h2 style="font-family: 'Inter', sans-serif; color: #111827;">Latest Updates</h2>
                                                <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                                    Here are our latest updates and news. We're excited to share what we've been working on.
                                                </p>
                                                
                                                <table style="width: 100%; border-spacing: 0; margin-top: 20px;">
                                                    <tr>
                                                        <td style="width: 30%; padding-right: 15px;">
                                                            <img src="https://via.placeholder.com/150" alt="Article Image" style="width: 100%; height: auto; border-radius: 4px;">
                                                        </td>
                                                        <td style="width: 70%;">
                                                            <h3 style="font-family: 'Inter', sans-serif; margin-top: 0; color: #111827;">Article Title</h3>
                                                            <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                                                A brief description of the article goes here. This is where you would introduce the content.
                                                            </p>
                                                            <a href="#" style="font-family: 'Inter', sans-serif; color: #4f46e5; text-decoration: none;">Read More →</a>
                                                        </td>
                                                    </tr>
                                                </table>
                                                
                                                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">
                                                
                                                <table style="width: 100%; border-spacing: 0;">
                                                    <tr>
                                                        <td style="width: 30%; padding-right: 15px;">
                                                            <img src="https://via.placeholder.com/150" alt="Article Image" style="width: 100%; height: auto; border-radius: 4px;">
                                                        </td>
                                                        <td style="width: 70%;">
                                                            <h3 style="font-family: 'Inter', sans-serif; margin-top: 0; color: #111827;">Another Article</h3>
                                                            <p style="font-family: 'Inter', sans-serif; line-height: 1.6; color: #374151;">
                                                                A brief description of another article goes here. Keep it concise but informative.
                                                            </p>
                                                            <a href="#" style="font-family: 'Inter', sans-serif; color: #4f46e5; text-decoration: none;">Read More →</a>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 20px; text-align: center; background-color: #f3f4f6;">
                                                <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #6b7280; margin: 0;">
                                                    © 2023 Your Company. All rights reserved.
                                                </p>
                                                <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #6b7280; margin-top: 10px;">
                                                    <a href="#" style="color: #4f46e5; text-decoration: none;">Unsubscribe</a> • 
                                                    <a href="#" style="color: #4f46e5; text-decoration: none;">View in Browser</a> • 
                                                    <a href="#" style="color: #4f46e5; text-decoration: none;">Privacy Policy</a>
                                                </p>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    `);
                }
            });
        });
    });
</script>
{% endblock %} 